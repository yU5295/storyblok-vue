<template lang="pug">
section
  PageBanner(className='text-center text-white')
    h1.headline.headline--large Sermons

  .container.mx-auto.px-6
    section.flex.justify-center.items-center.py-4(v-if="currentVideoId")
      YouTubePlayer(:videoId="currentVideoId")
    
    section.flex.justify-center.items-center.py-4
      a.yt-subscribe(target='_blank' href='https://www.youtube.com/channel/UCGFGRz9g8urP8GsgTzV48hg?sub_confirmation=1')
        img(alt='subscribe' src='~/assets/images/play-subscribe.png')
        | {{ $t('abonnez-vous') }}

    section.pt-4
      Pagination(
        :options="opts"
        @paginate="paginate"
        v-model="currentPage"
        :records="totalResults"
        :per-page="resultsPerPage"
      )

    section.yt-list
      ul.flex.flex-wrap.my-4.-mx-1(v-if="videos")
        YouTubeCard(v-for="video in videos" :key="video.id" :video="video" @click="setCurrentPlaying")

    section.pb-4
      Pagination(
        :options="opts"
        @paginate="paginate"
        v-model="currentPage"
        :records="totalResults"
        :per-page="resultsPerPage"
      )
</template>

<script lang="ts">
// @ts-ignore
import Pagination from 'vue-pagination-2'
import { defineComponent, watch, onMounted, ref, Ref } from '@vue/composition-api'

import usePagination from '~/hooks/usePagination'
import useYTPlaylist from '~/hooks/useYTPlaylist'

import PageBanner from '~/components/PageBanner.vue'
import YouTubeCard from '~/components/YouTubeCard.vue'
import YouTubePlayer from '~/components/YouTubePlayer.vue'
import CustomPagination from '~/components/CustomPagination.vue'

export default defineComponent({
  components: { PageBanner, Pagination, YouTubeCard, YouTubePlayer },

  setup() {
    const { videos, setNewPlaylist, populatePlaylist } = useYTPlaylist()
    const { totalResults, resultsPerPage, paginate, currentPage } = usePagination()

    const currentVideoId: Ref<string> = ref('')
    const setCurrentPlaying = (videoId: string) => (currentVideoId.value = videoId)

    watch(
      () => currentPage.value,
      async (page: number, oldPage: number) => {
        if (page > oldPage) {
          await setNewPlaylist('nextPage')
        } else {
          await setNewPlaylist('prevPage')
        }
        document.querySelector('.yt-subscribe')?.scrollIntoView({behavior: 'smooth'})
      }
    )

    onMounted(async () => {
      await populatePlaylist((data: any) => {
        totalResults.value = data.pageInfo.totalResults
        resultsPerPage.value = data.pageInfo.resultsPerPage
        currentVideoId.value = data.items[0].snippet.resourceId.videoId
      })
    })

    return {
      videos,
      paginate,
      currentPage,
      totalResults,
      resultsPerPage,
      currentVideoId,
      setCurrentPlaying,
      opts: { template: CustomPagination }
    }
  }
})
</script>
 
<style lang="stylus">
.yt-subscribe
  color $white
  padding 5px 10px
  border-radius 3px
  display inline-block
  text-decoration none
  background-color $yt-red
  img
    width 20px
    height auto
    vertical-align middle
    padding 0 6px 3px 0
    display inline-block
    background transparent
    -webkit-box-shadow none
    box-shadow none
    margin 0
</style>
